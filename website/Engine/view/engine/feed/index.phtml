<? 
$title = $this->_('Feed');
$this->headTitle($title, 'SET');
if($this->form){
	$form = $this->form;
} else {
    $form = new Activity\Form\MessageCreateForm();
}
$item = $this->item;
$items = $items;
$form->useSubFormGroup()
     ->setMethod($item['id'] ? 'put' : 'post')
     ->setView($this)
     ->setAction($this->uri('/activity/'))
     ->bind($item)
     ->prepare();
?>
<div class="container">

    <header class="page-header">
    <h2 class=""><?=$title?></h2>
    </header>
    <form id="activity-form" <?=$this->formAttr($form)?>>
        <?=$form->restful();?>
        <?=$form->helper('id');?>

        <div class="span10 well">
            <fieldset class="">
                <?=$form->helper('messageType', 'formText', array('class' => ''))?>        
                <?=$form->helper('content', 'formTextarea', array('class' => 'span10', 'rows' => 5))?>        
                <div class="help-block"><?=$form->helper('content', 'formElementErrors')?></div>
                <?=$form->helper('reference_id', 'formText', array('class' => ''))?>
                <?=$form->helper(array('MessageFile', 'file_id'), array('class' => ''))?>
                <h6 class="input-limit-message pull-right"><span class="input-limit">140</span> characters remaining</h6>
                <button class="btn btn-info" type="submit">Post New Message</button> <a id="img" class="btn" data-toggle="dropdown" href="#fileupload-modal"><i class="icon-picture"></i></a>
            </fieldset>
        </div><!--span10 end-->
    </form>

    <?foreach($items as $item):?>
    <div class="span8">
        <p><?=$item['ContentHtml']?></p>
        <?if($item['File']):?>
        <p><a href="<?=$item['File'][0]['Thumb']?>"><img src="<?=$this->thumb($item['File'][0]['Thumb'], array('w_200'))?>" alt="" class="img-polaroid" /></a></p>
        <?endif?>
        <div>
            <span class="badge badge-success">Posted <?=$item['createTime']?></span>
            <div class="pull-right"><span class="label">comment</span></div>
        </div> 
        <hr>
    </div>
    <?endforeach?>

</div>

<?=$this->widget('File', 'file/index')?>

<style>
    #fileupload-modal {
        position:absolute;
        margin:0;
        width:250px;
    }
</style>
<script>

    var modal = $("#fileupload-modal");
    eva.loader(eva.s('/static/eva/js/eva.jquery.evaTip.js'), function(){
        modal.hide();
        $('#img').on('click', function() {
            $(this).evaTip("show", {
                'tip' : modal,
                'offsetX' : -105,
                'offsetY' : 40,
                'direction' : 'bottom'			
            });
        });

        modal.find(".close").on("click", function(){
                modal.hide();
        });
    });

    var uploader = $('#singlefileupload');
    var form = $("#activity-form");
    uploader.bind('fileuploaddone', function (e, data) {
            var file = data.result[0];
            form.find('input[name="MessageFile[file_id]"]').val(file.id);
            modal.find(".close").hide();
    });
</script>
